<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta http-equiv="Cache-control" content="public">
    <meta name="theme-color" content="#fff">
    <link type='text/css' href='{{ styles }}' rel='stylesheet' media='screen' />
    {{ redcap_js|raw }}
    <script>
        $(document).ready(function () {
            // Show the modal and reset collapsibles when the button is clicked
            $('#sanitize-data').on('show.bs.modal', function () {
                // Collapse all collapsible items
                $('.collapse').collapse('hide');
                $('#message').hide();
            });

            /**
             * This method is triggered when the '#download-data-dictionary' button is clicked.
             * It dynamically creates a hidden form that sends data to a PHP file via a POST request.
             * The PHP file processes the provided data and generates a downloadable CSV file for the user.
             *
             * Key Steps:
             * 1. Retrieve SQL configuration (`projectSqls`) from the server-side.
             * 2. Replace placeholder constants in the SQL data with user-provided values from input fields.
             * 3. Create a hidden form and populate it with POST data (including CSRF token for security).
             * 4. Submit the form programmatically to trigger the PHP file execution.
             * 5. Remove the form from the DOM after submission for cleanup.
             * 6. Optionally provide visual feedback to the user (e.g., hiding modals or showing messages).
             *
             */
            $('#download-data-dictionary').on('click', function () {
                // Prepare POST data
                const projectSqls = {{ sql_fields_sanitize|json_encode|raw }};

                // Replace SQL pids with constants from input fields
                for (const key in projectSqls) {
                    if (key !== 'total' && projectSqls.hasOwnProperty(key)) {
                        const projects_sql = projectSqls[key];
                        const inputId = `pid-${projects_sql.pid}`;
                        const constantValue = document.getElementById(inputId).value;

                        // Replace the constant value in the SQL data object
                        projects_sql.constant = constantValue;
                    }
                }

                const postData = {
                    redcap_csrf_token: '{{ redcap_csrf_token | raw }}',
                    pid: '{{ pid | raw }}',
                    projectSqls: JSON.stringify(projectSqls)
                };

                // Create a hidden form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ download_data_dictionary_url | raw }}'; // URL pointing to PHP file

                // Add POST data as hidden fields
                for (const key in postData) {
                    if (postData.hasOwnProperty(key)) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = postData[key];
                        form.appendChild(input);
                    }
                }

                // Append the form to the body, submit it, and remove it
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);

                // Close the modal after triggering the download
                $('#sanitize-data').modal('hide');
                $('#message').show();
            });
        });
    </script>
</head>
<body>

   <div class="alert alert-success" style="display:none;margin-top: 20px;max-width: 690px;" id="message">Data Dictionary downloaded successfully!</div>

   <div class="row">
       <div class="mb-3">
           This module allows users to download the current Data Dictionary while replacing PIDs in all SQL fields with a placeholder defined on the module's configuration page.
       </div>
        <div class="col-sm-6">
            <div class="round chklist">
                <div class="chklisthdr">Instructions</div>
                <div class="chklisttext">
                    <p class="text-muted">Follow the instructions below to use the module:</p>
                    <ol>
                        <li class="mb-3">
                            <p>
                                Specify the name of the placeholder to replace the PID in the <a href="{{ APP_PATH_WEBROOT_ALL ~ "ExternalModules/manager/project.php?pid=" ~ pid }}" target="_blank">module's configuration</a>, or manually input the values afterward.
                            </p>
                        </li>
                        <li class="mb-3">
                            <p>
                                This project currently contains <strong>{{ sql_fields_sanitize.total }} SQL fields</strong>.
                            </p>
                        </li>
                        <li class="mb-3">
                            <p>
                                Click the button below to initiate the sanitation process.
                            </p>
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <div>
        <div class="mb-3 pt-3">Please review these SQL PIDs before proceeding with data sanitization.<br/>
            Alternatively, you may manually input and edit the values as needed.</div>
        {% for key, projects_sql in sql_fields_sanitize %}
            {% if key != "total" %}
                <h6 class="pt-4">PID {{"#" ~ projects_sql.pid ~ " - " }}<a href="{{ APP_PATH_WEBROOT_ALL ~ "index.php?pid=" ~ projects_sql.pid }}" target="_blank">{{ projects_sql.projectTitle }}</a></h6>
                <div class="ps-3 ">
                    <div class="pt-2">
                        Replace PID {{"#" ~ projects_sql.pid ~ " - " }} with: <input type="text" id="{{ "pid-" ~ projects_sql.pid }}" name="{{ "pid-" ~ projects_sql.pid }}" value="{{ projects_sql.constant }}">
                    </div>
                    <div class="pt-2">
                        <button class="btn btn-outline-secondary btn-sm d-flex align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ projects_sql.pid }}" aria-expanded="false" aria-controls="collapse-{{ projects_sql.pid }}">
                            <i class="fa fa-eye me-2"></i> See SQLs
                        </button>
                        <div class="collapse" id="collapse-{{ projects_sql.pid }}">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Variable name</th>
                                    <th>SQL Query</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for key_sql, sql in projects_sql.sqlVariables %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>[{{ key_sql | raw }}]</td>
                                        <td>{{ sql | raw }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    <div class="mt-5">
        <button type="button" class="btn btn-success" id="download-data-dictionary"><span class="fa fa-arrow-down"></span> Download</button>
    </div>


</body>
</html>
